---
{"dg-publish":true,"dg-path":"51单片机/内部定时计数器.md","permalink":"/51单片机/内部定时计数器/","dgPassFrontmatter":true,"noteIcon":"","created":"2024-04-18T20:19:23.869+08:00","updated":"2024-05-17T11:24:19.248+08:00"}
---

硬件构成的定时/技术器在使用上有不占用CPU 时间的优点，比使用循环程序产生延时要优越得多
提高 [[CPU\|CPU]] 的效率
[[计数器\|计数器]]
### 时钟系统

XTAL1和XTAL2之间跨接[[晶振\|晶体振荡器]]和微调[[电容\|电容]]，从而构成一个稳定的自激振荡器

MCS-51 振荡频率 6MHZ 或 12MHZ  

***机器周期:***
完成一个基本操作所需的时间，包含 12 个振荡周期
1us  1 微秒


[[特殊功能寄存器\|特殊功能寄存器]]
### T1  T0
Time High/Low   TH/TL
`T0`:  `TH0`  +  `TL0`            
`T1`:  `TH1`  +  `TL1` 
十六位计数器=高八位(TH)+低八位(TL)计数器

### TCON
`TCON`    控制器寄存器  88H
低四位用于外部中断

| 8FH     | 8EH     | 8DH     | 8CH     | 8BH | 8AH | 89H | 88H |
| ------- | ------- | ------- | ------- | --- | --- | --- | --- |
| TF1     | TR1     | TF0     | TR0     | IE1 | IT1 | TE0 | IT0 |
| T1 溢出标志 | T1 运行控制 | T0 溢出标志 | T0 运行控制 |     |     |     |     |

运行控制：软件上的启动
溢出标志：硬件上的标志位

### TMOD

`TMOD`   工作模式寄存器   89H
不可位寻址
只能用字节设置定时器的工作模式，
**低半字节**设置==T0==，**高半字节**设置==T1==

| GATE | $C/\overline{T}$ | M1  | M0  | GATE | $C  /  \overline{T}$ | M1  | M0  |
| ---- | ---------------- | --- | --- | ---- | -------------------- | --- | --- |

#### GATE    选通控制
==1==：受 $\overline{INT_{1}}$  /  $\overline{INT_{0}}$ 控制
先要硬件上的 $\overline{INT_{1}}$  /  $\overline{INT_{0}}$ 的引脚为高电平
才能通过 TR0 或 TR1 置 1 启动对应的计数器

==0==：不受 $\overline{INT_{1}}$ 控制
使计数器的 TR0 或 TR1 置 1就可启动对应的计数器 T0 或 T1

####  $C/\overline{T}$      功能选择
==1==：计数
计数器的输入来自T0（P3.4）或T1（P3.5）端的外部脉冲
==0==：定时  
定时器计数8051片内脉冲，即对机器周期计数

#### M1 M0  工作模式
==00==：模式 0   13 位计数器
==01==：模式 1    16 位计数器
==10==：模式 2    自动再装入 8 位计数器，自动重装载
==11==：模式 3    T0 分成两个 8 位计数器，T1 停止计数


![Pasted image 20240513153526.png](/img/user/%E5%8A%9F%E8%83%BD%E6%80%A7%E6%96%87%E4%BB%B6%E5%A4%B9/%E8%BD%BD%E5%85%A5%E7%9A%84%E5%AA%92%E4%BD%93%E8%B5%84%E6%BA%90/Pasted%20image%2020240513153526.png)


### 模式 1
16 位计数器
>[!question] 
设T0工作模式1，定时时间为1ms，fosc=12MH
编程实现其定时功能。定时时间到，P1.0取反

T0 工作模式 1 
	TMOD : 0000 0001 --> 01H
fosc=12MH -->  机器周期 1us
定时时间为 1ms  =1000×1us
设置 T0 计数器初值:  $2^{16}-1000=64536$
	高八位 TH0：
	1111 1110    -->  0FCH
	低八位 TL0：
	0001 1000  --> 18H
启动 T0
	TCON   按位： TR0 -->  1
	
#### 查询方式

```Assembly
MOV TMOD,#01H
MOV TL0,#18H
MOV TH0,#0FCH  
STEB TR0

LOOP:JBC  TF0,NEXT  
	 SJMP LOOP  
NEXT:MOV TL0,#18H
	 MOV TH0,#0FCH 
	 CPL P1.0
	 SJMP LOOP  
```

[[C51\|C51]]
```C
#include<reg51.h>
sbit P1_0=P1^0;
void main(void)
{
	TMOD=0x01;
	TH0=0xFC;
	TL0=0x18;
	TR0=1;
	while(1)
	{
	 do{}
	 while(!TF0);
	 P1_0=!P1_0;
	 TH0=0xFC;
	 TL0=0x18;
	 TF=0; 
	}
}
```

#### 中断方式
[[中断系统\|中断系统]]



定时器中断标志位作为中断信号

~~中断能干更多的事情（资源的分配策略）~~
中断的概念实际上很符合人的实际和生活

标志位表征“重要的”事情发生了
CPU 来判断电信号的高低电平，作出响应



### 模式二

TH0 保存初值
TL0 用作 8 位计数器   0～255
计数次数 255+1-TH0

串行口波特率发生器  [[串行通信\|串行通信]]


TMOD
0110 000  T1 计时器模式二

计数 100 次
256-100=156  -->1001 1100  -->   9CH  
